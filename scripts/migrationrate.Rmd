---
title: "Migration Rate"
output: html_document
---

```{r Load the Data, echo=TRUE, message=FALSE, warning=FALSE}
library(dplyr)
library(magrittr)
library(ggplot2)
library(ggplot2bdc)
library(Hmisc)

load(file='../data/gnhdata.rda')
source('gnh_summary.R')
source('gnh_labels.R')

struct_labeler <- function(variable, value)
{
    labels <- c('lattice, 25x25'='Structured',
                'well-mixed, 625'='Unstructured')
    return(labels[value])
}

migration_labels <- c('5e-7'='0.0000005', '5e-6'='0.000005', '5e-5'='0.00005',
                      '5e-4'='0.0005', '5e-3'='0.005', '5e-2'=expression(bold('0.05')),
                      '5e-1'='0.5')

migration_labels <- c('0.0000005','0.000005','0.00005', '0.0005', '0.005', expression(bold('0.05')), '0.5')

migration_labels_f <- c('5e-7'='0.0000005', '5e-6'='0.000005', '5e-5'='0.00005',
                      '5e-4'='0.0005', '5e-3'='0.005', '5e-2'='0.05',
                      '5e-1'='0.5')
```

```{r subsetting}
migration_data <- gnhdata %>%
    filter(GenomeLength==8) %>%
    filter(PopulationStructure=='lattice, 25x25') %>%
    filter(SocialMutations==TRUE) %>%
    filter(FitnessDistribution=='uniform') %>%
    filter(MinCarryingCapacity==800 & MaxCarryingCapacity==2000) %>%
    filter(MutationRateSocial==1e-5 & MutationRateAdaptation==1e-5 & MutationRateStress==1e-5)
```

```{r analysis}
migration_prop <- migration_data %>%
    group_by(Time, MigrationRate) %>%
    do(gnh_summary(.$MeanProducerProportion))

migration_pres <- migration_data %>%
    group_by(MigrationRate, Replicate, Source) %>%
    summarise(Integral=sum(MeanProducerProportion)/(max(Time)-min(Time)))

```

```{r Proportion of Producers}
p_proportion <- ggplot(migration_prop, aes(x=Time, y=Mean,
                                           color=as.factor(MigrationRate),
                                           fill=as.factor(MigrationRate))) +
    geom_hline(yintercept=0.5, linetype='dotted', size=0.5, color='grey70') +   
    geom_ribbon(aes(ymin=CL95_lower, ymax=CL95_upper), color=NA, alpha=0.2) +   
    geom_line() +
    scale_color_hue(name=label_migration_rate, labels=migration_labels, guide=guide_legend(order=1)) +
    scale_fill_hue(guide=FALSE) +
    labs(x=label_time, y=label_producer_proportion) +
    theme_bdc_grey()
rescale_golden(p_proportion)
# ggsave_golden('../figures/all-migration-proportion.png')

```


```{r Normalized Producer Presence}
p_presence <- ggplot(migration_pres, aes(x=MigrationRate, y=Integral)) +
    geom_point(shape=1, alpha=0.06, position='identity') +
    stat_summary(fun.data='mean_cl_boot') +
    scale_x_log10(breaks=unique(migration_pres$MigrationRate),
                  labels=migration_labels) +
    scale_y_continuous(limits=c(0,0.1)) +
    labs(x=label_migration_rate, y=label_producer_presence) +
    theme_bdc_grey(grid.y=FALSE)
rescale_golden(p_presence)
# ggsave_golden('../figures/all-migration-presence.png')
```
